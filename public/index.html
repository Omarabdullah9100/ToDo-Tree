<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Do Tree</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="Images/favicon.png">

    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.1.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.2/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.2/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.2/firebase-messaging.js"></script>
</head>

<body>
    <!-- Sign-In Form -->
    <div id="sign-in-container">
        <h2>Sign In</h2>
        <input type="email" id="email" placeholder="Email" required>
        <input type="password" id="password" placeholder="Password" required>
        <button id="sign-in-button">Sign In</button>
        <p>Don't have an account? <a href="#" id="sign-up-link">Sign Up</a></p>
    </div>

    <!-- Sign-Up Form -->
    <div id="sign-up-container" style="display: none;">
        <h2>Sign Up</h2>
        <input type="email" id="new-email" placeholder="Email" required>
        <input type="password" id="new-password" placeholder="Password" required>
        <button id="sign-up-button">Sign Up</button>
        <p>Already have an account? <a href="#" id="sign-in-link">Sign In</a></p>
    </div>

    <!-- Main To-Do List (Visible After Sign-In) -->
    <div class="container" id="todo-container" style="display: none;">
        <div class="todoapp">
            <h2>To-Do List <img src="Images/checklist_icon.png" alt="Checklist Icon"></h2>
            <div class="row">
                <input type="text" id="input-box" placeholder="Add your task">
                <select id="category-select">
                    <option value="Work">Work</option>
                    <option value="Personal">Personal</option>
                    <option value="Urgent">Urgent</option>
                    <option value="Others">Others</option>
                </select>
                <input type="datetime-local" id="reminder-select">
                <button onclick="addTask()">Add</button>
            </div>
            <ul id="list-container"></ul>
        </div>
    </div>

    <!-- Firebase Initialization -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDQUzseHoekIQihohpW-8XFy-fKvibbS8c",
            authDomain: "todo-list-9dbcf.firebaseapp.com",
            projectId: "todo-list-9dbcf",
            storageBucket: "todo-list-9dbcf.appspot.com",
            messagingSenderId: "503251074837",
            appId: "1:503251074837:web:9ab8901930ba884953f31c"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();  // Firebase Auth
        const firestore = firebase.firestore();
        const messaging = firebase.messaging(app);

        // Show sign-in or sign-up form based on user state
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('User signed in:', user.uid);
                requestPermission(); // Request push notification permission after sign-in
                showTodoPage();
            } else {
                showSignInPage();
            }
        });

        // Show sign-in form
        function showSignInPage() {
            document.getElementById('sign-in-container').style.display = 'block';
            document.getElementById('sign-up-container').style.display = 'none';
            document.getElementById('todo-container').style.display = 'none';
        }

        // Show to-do page after sign-in
        function showTodoPage() {
            document.getElementById('sign-in-container').style.display = 'none';
            document.getElementById('sign-up-container').style.display = 'none';
            document.getElementById('todo-container').style.display = 'block';
            displayTasks(); // Load tasks on page load
        }

        // Sign In
        document.getElementById('sign-in-button').addEventListener('click', signIn);
        function signIn() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    console.log('Signed in as: ', user.uid);
                    window.location.reload();
                })
                .catch((error) => {
                    console.error("Error signing in: ", error.message);
                });
        }

        // Sign Up
        document.getElementById('sign-up-button').addEventListener('click', signUp);
        function signUp() {
            const email = document.getElementById('new-email').value;
            const password = document.getElementById('new-password').value;

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    console.log('User signed up with UID: ', user.uid);
                    window.location.reload();
                })
                .catch((error) => {
                    console.error("Error signing up: ", error.message);
                });
        }

        // Request notification permission and save token
        async function requestPermission() {
            try {
                const permission = await Notification.requestPermission();
                if (permission === "granted") {
                    console.log("Notification permission granted.");
                    const token = await messaging.getToken({ vapidKey: "YOUR_VAPID_KEY" });
                    if (token) {
                        console.log("FCM Token:", token);
                        saveTokenToFirestore(token);
                    }
                }
            } catch (error) {
                console.error("Error requesting notification permission:", error);
            }
        }

        // Save FCM token to Firestore
        function saveTokenToFirestore(token) {
            const user = auth.currentUser;
            if (user) {
                const userRef = firestore.collection("users").doc(user.uid);
                userRef.set({ fcmToken: token }, { merge: true })
                    .then(() => console.log("FCM Token saved to Firestore."))
                    .catch(error => console.error("Error saving token:", error));
            }
        }

        // Add Task
        function addTask() {
            const taskInput = document.getElementById("input-box").value;
            const categorySelect = document.getElementById("category-select").value;
            const reminderDate = document.getElementById("reminder-select").value;

            if (taskInput) {
                const tasksRef = firestore.collection("tasks");

                tasksRef.add({
                    name: taskInput,
                    category: categorySelect,
                    reminder: reminderDate,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                }).then(() => {
                    console.log("Task added to Firestore.");
                    displayTasks(); // Refresh task list
                }).catch(error => {
                    console.error("Error adding task:", error);
                });

                // Clear input fields
                document.getElementById("input-box").value = '';
                document.getElementById("category-select").value = 'Work';
                document.getElementById("reminder-select").value = '';
            }
        }

        // Display Tasks from Firestore
        function displayTasks() {
            const listContainer = document.getElementById("list-container");
            listContainer.innerHTML = ''; // Clear previous tasks

            const tasksRef = firestore.collection("tasks").orderBy("timestamp", "desc");
            tasksRef.get().then((querySnapshot) => {
                querySnapshot.forEach((doc) => {
                    const task = doc.data();
                    const li = document.createElement("li");

                    li.innerHTML = `
                        <span class="task-name">${task.name}</span>
                        <span class="category">${task.category}</span>
                        <span class="reminder">${task.reminder}</span>
                        <button class="delete-btn">Delete</button>
                        <button class="complete-btn">Complete</button>
                    `;

                    li.querySelector(".delete-btn").addEventListener("click", () => {
                        deleteTask(doc.id);
                        li.remove();
                    });

                    li.querySelector(".complete-btn").addEventListener("click", () => {
                        completeTask(doc.id);
                        li.classList.add("checked"); // Visual indication of completion
                    });

                    listContainer.appendChild(li);
                });
            }).catch(error => {
                console.error("Error fetching tasks:", error);
            });
        }

        // Delete Task
        function deleteTask(taskId) {
            const taskRef = firestore.collection("tasks").doc(taskId);
            taskRef.delete()
                .then(() => console.log("Task deleted"))
                .catch(error => console.error("Error deleting task:", error));
        }

        // Mark Task as Complete
        function completeTask(taskId) {
            const taskRef = firestore.collection("tasks").doc(taskId);
            taskRef.update({ completed: true })
                .then(() => console.log("Task marked as complete"))
                .catch(error => console.error("Error completing task:", error));
        }
    </script>
</body>
</html>
